1FROM golang:alpine as builder

#ARG MYSQL_USER
#ARG MYSQL_PASS
#ARG MYSQL_HOST
#ARG MYSQL_PORT
#ARG MYSQL_DBNAME
#ENV MYSQL_USER=$MYSQL_USER MYSQL_PASS=$MYSQL_PASS MYSQL_HOST=$MYSQL_HOST MYSQL_PORT=$MYSQL_PORT MYSQL_DBNAME=$MYSQL_DBNAME

WORKDIR /app

#COPY go.mod .
#COPY go.sum .
#COPY docker/go/.netrc docker/go/.netrc
#RUN cp ./docker/go/.netrc $HOME/
#RUN go mod download
RUN go install github.com/billizzard/go-mysql-migration@latest
RUN mv $GOPATH/bin/go-mysql-migration /usr/bin/migrations
COPY . .
RUN go build -o /app/mainApp

RUN ["chmod", "+x", "/app/mainApp"]
#RUN ls -la /app
#CMD [ "/app/mainApp" ]

#build tiny docker image
FROM alpine:latest

ARG MYSQL_USER
ARG MYSQL_PASS
ARG MYSQL_HOST
ARG MYSQL_PORT
ARG MYSQL_DBNAME
ENV MYSQL_USER=$MYSQL_USER MYSQL_PASS=$MYSQL_PASS MYSQL_HOST=$MYSQL_HOST MYSQL_PORT=$MYSQL_PORT MYSQL_DBNAME=$MYSQL_DBNAME

RUN mkdir /app
COPY --from=builder /app/mainApp /app
COPY --from=builder /app/public /app/public
COPY --from=builder /app/db/migrations /app/db/migrations
# file for run migrations
COPY --from=builder /usr/bin/migrations /usr/bin/migrations
COPY --from=builder /app/config/keys /app/config/keys

RUN chmod 777 /app/mainApp

EXPOSE 80
EXPOSE 50001

CMD [ "/app/mainApp" ]